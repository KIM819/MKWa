<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>平均順位の確認と記録</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 20px auto; }
    label { display: inline-block; width: 120px; margin-top: 8px; }
    select, button { margin: 5px 0; padding: 5px; }
    .avg-set { margin-left: 20px; margin-bottom: 10px; border: 1px solid #ccc; padding: 10px; }
    .rec-a, .rec-b { margin-left: 20px; margin-bottom: 10px; }
    #resultArea, #recordList { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background: #f4f4f4; }
    .record-entry { white-space: pre-line; }
  </style>
</head>
<body>

  <h2>平均順位の確認</h2>
  <form id="averageForm">
    <label>Bモード共通スタート：</label>
    <select id="sharedBStart"></select>
    <div id="avgInputs"></div>
    <button type="submit">平均順位を表示</button>
  </form>
  <div id="resultArea"></div>

  <hr>

  <h2>記録の追加</h2>
  <form id="recordForm">
    <label>モード：</label>
    <select id="recMode">
      <option value="A">Aモード</option>
      <option value="B">Bモード</option>
    </select>
    <div class="rec-a" id="recA">
      <label>コース：</label>
      <select id="recACourse"></select>
    </div>
    <div class="rec-b" id="recB" style="display:none;">
      <label>スタート：</label>
      <select id="recBStart"></select>
      <label>ゴール：</label>
      <select id="recBGoal"></select>
    </div>
    <label for="recRank">順位：</label>
    <select id="recRank"></select>
    <button type="submit">記録を保存</button>
  </form>

  <h3>記録一覧</h3>
  <div id="recordList" class="record-entry"></div>

<script>
const courseNames = {
  1:"アイスビルディング", 2:"ワリオシップ", 3:"ピーチビーチ", 4:"ロゼッタてんもんだい", 5:"DKスノーマウンテン",
  6:"ソルティータウン", 7:"ハテナしんでん", 8:"おばけシネマ", 9:"ショーニューロード", 10:"プクプクフォールズ",
  11:"リバーサイドサファリ", 12:"ディノディノジャングル", 13:"どんぐりツリーハウス", 14:"マリオサーキット", 15:"モーモーカントリー",
  16:"ピーチスタジアム", 17:"ノコノコビーチ", 18:"ホネホネツイスター", 19:"キノピオファクトリー", 20:"チョコマウンテン",
  21:"トロフィーシティ", 22:"DKうちゅうセンター", 23:"クッパキャッスル", 24:"ワリオスタジアム", 25:"マリオブラザーズサーキット",
  26:"シュポポコースター", 27:"キラーシップ", 28:"ヘイホーカーニバル", 29:"サンサンさばく", 30:"レインボーロード"
};

const connected = {
  1:[2,4,5,6,9], 2:[1,2,4,5,6,10], 3:[2,6,7,11], 4:[1,2,5,8,9,10,14],
  5:[1,2,4,6,9,10,15], 6:[2,3,5,7,10,11,12], 7:[3,6,11,12,17], 8:[4,9,13,14,18],
  9:[1,4,5,8,10,13,14,15,19], 10:[2,4,5,6,9,11,15,16], 11:[6,7,10,12,16,17,21],
  12:[6,7,11,17], 13:[8,9,14,18,19], 14:[8,9,13,15,18,19,23], 15:[9,10,14,16,18,19,20],
  16:[10,11,15,17,19,20,21], 17:[11,12,16,21,22], 18:[8,13,14,15,19,23,24,27],
  19:[9,13,14,15,16,18,20,23,24,25,27], 20:[15,16,19,21,23,24,25,26,28],
  21:[11,15,16,17,20,22,24,25,26,29], 22:[16,17,21,26], 23:[14,18,19,20,23,27],
  24:[18,19,20,21,23,25,27,28], 25:[19,20,21,24,26,28,29], 26:[20,21,22,25,29],
  27:[18,19,23,24,28], 28:[14,15,27,29], 29:[25,26,28]
};

function populateSelect(select, options) {
  select.innerHTML = "";
  options.forEach(val => {
    const op = document.createElement("option");
    op.value = val;
    op.textContent = `【${val}】${courseNames[val] || val}`;
    select.appendChild(op);
  });
}

function saveRecords(records) {
  localStorage.setItem("records", JSON.stringify(records));
}
function loadRecords() {
  return JSON.parse(localStorage.getItem("records") || "[]");
}

function updateRecordList() {
  const records = loadRecords();
  const out = records.map((r, i) => {
    if (r.mode === "A") {
      return `[${i+1}]\nモード：A\nコース：${courseNames[r.course]}\n順位　：${r.rank}位`;
    } else {
      return `[${i+1}]\nモード：B\nスタート：${courseNames[r.start]}\nゴール　：${courseNames[r.goal]}\n順位　　：${r.rank}位`;
    }
  });
  document.getElementById("recordList").innerText = out.join("\n\n");
}

function createAverageInputs() {
  const container = document.getElementById("avgInputs");
  container.innerHTML = "";
  for (let i = 0; i < 3; i++) {
    const block = document.createElement("div");
    block.className = "avg-set";
    block.innerHTML = `
      <label>モード：</label>
      <select class="avgType" data-index="${i}">
        <option value="A">Aモード</option>
        <option value="B">Bモード</option>
      </select><br>
      <div class="avg-a">
        <label>コース：</label>
        <select class="avgACourse"></select>
      </div>
      <div class="avg-b" style="display:none">
        <label>ゴール：</label>
        <select class="avgBGoal"></select>
      </div>
    `;
    container.appendChild(block);
  }
  document.querySelectorAll(".avgACourse").forEach(sel => populateSelect(sel, Object.keys(courseNames)));
  document.querySelectorAll(".avgBGoal").forEach(sel => populateSelect(sel, Object.keys(courseNames)));
  populateSelect(document.getElementById("sharedBStart"), Object.keys(courseNames));
  document.getElementById("sharedBStart").addEventListener("change", () => {
    const val = parseInt(document.getElementById("sharedBStart").value);
    document.querySelectorAll(".avgBGoal").forEach(goal => populateSelect(goal, connected[val] || []));
  });
  document.getElementById("sharedBStart").dispatchEvent(new Event("change"));
  document.querySelectorAll(".avgType").forEach(sel => {
    sel.addEventListener("change", e => {
      const isA = e.target.value === "A";
      const parent = e.target.closest(".avg-set");
      parent.querySelector(".avg-a").style.display = isA ? "block" : "none";
      parent.querySelector(".avg-b").style.display = isA ? "none" : "block";
    });
  });
}

function calcAverageRank() {
  const records = loadRecords();
  const sets = document.querySelectorAll(".avg-set");
  const result = [];
  const bStart = parseInt(document.getElementById("sharedBStart").value);
  sets.forEach((block, i) => {
    const mode = block.querySelector(".avgType").value;
    if (mode === "A") {
      const course = parseInt(block.querySelector(".avgACourse").value);
      const others = records.filter(r => r.mode === "A" && r.course !== course);
      const avg = others.length ? (others.reduce((s, r) => s + r.rank, 0) / others.length).toFixed(2) : "データなし";
      result.push(`Aモード【${courseNames[course]}】を除く平均順位：\n${avg}`);
    } else {
      const goal = parseInt(block.querySelector(".avgBGoal").value);
      const matched = records.filter(r => r.mode === "B" && r.start == bStart && r.goal == goal);
      const avg = matched.length ? (matched.reduce((s, r) => s + r.rank, 0) / matched.length).toFixed(2) : "データなし";
      result.push(`Bモード【${courseNames[bStart]}→${courseNames[goal]}】の平均順位：\n${avg}`);
    }
  });
  document.getElementById("resultArea").innerText = result.join("\n\n");
}

document.getElementById("averageForm").addEventListener("submit", e => {
  e.preventDefault();
  calcAverageRank();
});

document.getElementById("recMode").addEventListener("change", e => {
  const isA = e.target.value === "A";
  document.getElementById("recA").style.display = isA ? "block" : "none";
  document.getElementById("recB").style.display = isA ? "none" : "block";
});

function setupForm() {
  populateSelect(document.getElementById("recACourse"), Object.keys(courseNames));
  populateSelect(document.getElementById("recBStart"), Object.keys(courseNames));
  populateSelect(document.getElementById("recBGoal"), []);
  for (let i = 1; i <= 24; i++) {
    const op = document.createElement("option");
    op.value = i;
    op.textContent = `${i}位`;
    document.getElementById("recRank").appendChild(op);
  }
  document.getElementById("recBStart").addEventListener("change", e => {
    const val = parseInt(e.target.value);
    populateSelect(document.getElementById("recBGoal"), connected[val] || []);
  });
  document.getElementById("recBStart").dispatchEvent(new Event("change"));
}

document.getElementById("recordForm").addEventListener("submit", e => {
  e.preventDefault();
  const records = loadRecords();
  const mode = document.getElementById("recMode").value;
  const rank = parseInt(document.getElementById("recRank").value);
  if (mode === "A") {
    const course = parseInt(document.getElementById("recACourse").value);
    records.push({ mode: "A", course, rank });
  } else {
    const start = parseInt(document.getElementById("recBStart").value);
    const goal = parseInt(document.getElementById("recBGoal").value);
    records.push({ mode: "B", start, goal, rank });
  }
  saveRecords(records);
  updateRecordList();
  e.target.reset();
  document.getElementById("recBStart").dispatchEvent(new Event("change"));
});

createAverageInputs();
setupForm();
updateRecordList();
</script>
</body>
</html>
