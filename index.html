<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É¨„Éº„Ç∑„É≥„Ç∞„Ç≤„Éº„É† „Éá„Éº„Çø„Éà„É©„ÉÉ„Ç´„Éº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .main-content {
            padding: 30px;
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 15px;
        }

        .mode-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .mode-btn.active {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            transform: translateY(-2px);
        }

        .mode-btn:not(.active) {
            background: #f8f9fa;
            color: #333;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #4ecdc4;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: end;
        }

        .form-col {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            background: white;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #a8e6cf, #dcedc8);
            color: #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .course-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .course-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
        }

        .course-name {
            font-weight: bold;
            color: #333;
        }

        .course-rank {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .hidden {
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #28a745;
        }

        .csv-format-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .format-example {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .mode-selector {
                flex-direction: column;
                align-items: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÅ „É¨„Éº„Ç∑„É≥„Ç∞„Ç≤„Éº„É† „Éá„Éº„Çø„Éà„É©„ÉÉ„Ç´„Éº</h1>
            <p>„Ç≥„Éº„ÇπËµ∞Ë°å„Éá„Éº„Çø„ÅÆË®òÈå≤„Å®ÂàÜÊûê</p>
        </div>

        <div class="main-content">
            <!-- „É¢„Éº„ÉâÈÅ∏Êäû -->
            <div class="mode-selector">
                <button class="mode-btn active" onclick="switchMode('input')">üìù „Éá„Éº„ÇøÂÖ•Âäõ</button>
                <button class="mode-btn" onclick="switchMode('stats')">üìä Áµ±Ë®àÁ¢∫Ë™ç</button>
                <button class="mode-btn" onclick="switchMode('csv')">üíæ CSVÁÆ°ÁêÜ</button>
            </div>

            <!-- „Éá„Éº„ÇøÂÖ•Âäõ„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div id="input-section" class="section">
                <h2>üéÆ „É¨„Éº„ÇπÁµêÊûúÂÖ•Âäõ</h2>
                
      
                
                
                <!-- „Ç≤„Éº„É†„É¢„Éº„ÉâÈÅ∏Êäû -->
                <div class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <label>„Ç≤„Éº„É†„É¢„Éº„Éâ:</label>
                            <select id="gameMode" onchange="updateCourseSelection()">
                                <option value="A">A„É¢„Éº„Éâ (Âçò‰∏Ä„Ç≥„Éº„Çπ)</option>
                                <option value="B">B„É¢„Éº„Éâ („Ç≥„Éº„ÇπÈñìËµ∞Ë°å)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- A„É¢„Éº„ÉâÁî®ÂÖ•Âäõ -->
                <div id="mode-a-inputs" class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <label>„Ç≥„Éº„Çπ:</label>
                            <select id="courseA">
                                <option value="">„Ç≥„Éº„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label>È†Ü‰Ωç:</label>
                            <select id="rankA">
                                <option value="">È†Ü‰Ωç„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <button class="btn" onclick="addRecord('A')">Ë®òÈå≤ËøΩÂä†</button>
                        </div>
                    </div>
                </div>

                <!-- B„É¢„Éº„ÉâÁî®ÂÖ•Âäõ -->
                <div id="mode-b-inputs" class="form-group hidden">
                    <div class="form-row">
                        <div class="form-col">
                            <label>„Çπ„Çø„Éº„Éà„Ç≥„Éº„Çπ:</label>
                            <select id="startCourse" onchange="updateGoalCourses()">
                                <option value="">„Çπ„Çø„Éº„Éà„Ç≥„Éº„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label>„Ç¥„Éº„É´„Ç≥„Éº„Çπ:</label>
                            <select id="goalCourse">
                                <option value="">„Ç¥„Éº„É´„Ç≥„Éº„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label>È†Ü‰Ωç:</label>
                            <select id="rankB">
                                <option value="">È†Ü‰Ωç„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <button class="btn" onclick="addRecord('B')">Ë®òÈå≤ËøΩÂä†</button>
                        </div>
                    </div>
                </div>

                <div id="success-message" class="success-message hidden">
                    „É¨„Éº„ÇπÁµêÊûú„ÅåÊ≠£Â∏∏„Å´Ë®òÈå≤„Åï„Çå„Åæ„Åó„ÅüÔºÅ
                </div>
            </div>

          <!-- Áµ±Ë®àÁ¢∫Ë™ç„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div id="stats-section" class="section hidden">
                <h2>üìä Áµ±Ë®à„Éá„Éº„Çø</h2>
                
                <!-- A„É¢„Éº„ÉâÈÅ∏Êäû -->
                <div class="form-group">
                    <h3>üèÅ A„É¢„Éº„Éâ (Âçò‰∏Ä„Ç≥„Éº„Çπ) - 3„Å§„Åæ„ÅßÈÅ∏Êäû</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label>A„É¢„Éº„Éâ„Ç≥„Éº„ÇπÈÅ∏Êäû:</label>
                            <select id="statsCoursesSelectA" multiple size="4">
                            </select>
                            <small>Ctrl„Ç≠„Éº„ÇíÊäº„Åó„Å™„Åå„Çâ„ÇØ„É™„ÉÉ„ÇØ„ÅßË§áÊï∞ÈÅ∏Êäû</small>
                        </div>
                    </div>
                </div>

                <!-- B„É¢„Éº„ÉâÈÅ∏Êäû -->
                <div class="form-group">
                    <h3>üèéÔ∏è B„É¢„Éº„Éâ („Ç≥„Éº„ÇπÈñìËµ∞Ë°å) - 3„Å§„Åæ„ÅßÈÅ∏Êäû</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label>B„É¢„Éº„Éâ„Ç≥„Éº„ÇπÈñìÈÅ∏Êäû:</label>
                            <select id="statsCoursesSelectB" multiple size="4">
                            </select>
                            <small>Ctrl„Ç≠„Éº„ÇíÊäº„Åó„Å™„Åå„Çâ„ÇØ„É™„ÉÉ„ÇØ„ÅßË§áÊï∞ÈÅ∏Êäû</small>
                        </div>
                    </div>
                </div>

                <!-- Êìç‰Ωú„Éú„Çø„É≥ -->
                <div class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <button class="btn" onclick="displayCombinedStats()">A„ÉªB‰∏°„É¢„Éº„ÉâÁµ±Ë®àË°®Á§∫</button>
                        </div>
                        <div class="form-col">
                            <button class="btn btn-secondary" onclick="clearAllData()">ÂÖ®„Éá„Éº„Çø„ÇØ„É™„Ç¢</button>
                        </div>
                    </div>
                </div>

                <div id="stats-display" class="stats-grid">
                    <!-- Áµ±Ë®à„Éá„Éº„Çø„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                </div>
            </div>
                <div id="stats-display" class="stats-grid">
                    <!-- Áµ±Ë®à„Éá„Éº„Çø„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                </div>
            </div>

            <!-- CSVÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div id="csv-section" class="section hidden">
                <h2>üíæ CSV „Éá„Éº„ÇøÁÆ°ÁêÜ</h2>
                
                <!-- CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà -->
                <div class="form-group">
                    <h3>üì§ „Éá„Éº„Çø„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà</h3>
                    <p>ÁèæÂú®„ÅÆ„Éá„Éº„Çø„ÇíCSV„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åß„Åç„Åæ„Åô„ÄÇ</p>
                    <div class="form-row">
                        <div class="form-col">
                            <button class="btn" onclick="exportToCSV('A')">A„É¢„Éº„Éâ„Éá„Éº„Çø„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
                        </div>
                        <div class="form-col">
                            <button class="btn" onclick="exportToCSV('B')">B„É¢„Éº„Éâ„Éá„Éº„Çø„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
                        </div>
                        <div class="form-col">
                            <button class="btn" onclick="exportToCSV('ALL')">ÂÖ®„Éá„Éº„Çø„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
                        </div>
                    </div>
                </div>

                <!-- CSV„Ç§„É≥„Éù„Éº„Éà -->
                <div class="form-group">
                    <h3>üì• „Éá„Éº„Çø„ÅÆ„Ç§„É≥„Éù„Éº„Éà</h3>
                    <p>CSV„Éï„Ç°„Ç§„É´„Åã„Çâ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô„ÄÇÊó¢Â≠ò„ÅÆ„Éá„Éº„Çø„Å´ËøΩÂä†„Åï„Çå„Åæ„Åô„ÄÇ</p>
                    <div class="form-row">
                        <div class="form-col">
                            <label>CSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû:</label>
                            <input type="file" id="csvFileInput" accept=".csv" onchange="handleCSVUpload(event)">
                        </div>
                        <div class="form-col">
                            <button class="btn btn-secondary" onclick="downloadSampleCSV()">„Çµ„É≥„Éó„É´CSV„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
                        </div>
                    </div>
                </div>

                <!-- CSVÂΩ¢ÂºèË™¨Êòé -->
                <div class="form-group">
                    <h3>üìã CSVÂΩ¢Âºè„Å´„Å§„ÅÑ„Å¶</h3>
                    <div class="csv-format-info">
                        <p><strong>CSV„Éï„Ç°„Ç§„É´„ÅÆÂΩ¢Âºè:</strong></p>
                        <div class="format-example">
                            <p><strong>A„É¢„Éº„Éâ:</strong> Mode,Course,CourseName,Rank,Date</p>
                            <p><strong>B„É¢„Éº„Éâ:</strong> Mode,StartCourse,StartCourseName,GoalCourse,GoalCourseName,Rank,Date</p>
                        </div>
                        <p><small>‚Äª Êó•‰ªò„ÅØËá™Âãï„ÅßÁèæÂú®ÊôÇÂàª„ÅåË®≠ÂÆö„Åï„Çå„Åæ„Åô</small></p>
                    </div>
                </div>

                <div id="csv-message" class="success-message hidden">
                    CSVÂá¶ÁêÜ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ
                </div>
            </div>
        </div>
    </div>

    <script>
        // „Ç≥„Éº„ÇπÂêç„Éá„Éº„Çø
        const courseNames = {
            1: "„Ç¢„Ç§„Çπ„Éì„É´„Éá„Ç£„É≥„Ç∞",
            2: "„ÉØ„É™„Ç™„Ç∑„ÉÉ„Éó",
            3: "„Éî„Éº„ÉÅ„Éì„Éº„ÉÅ",
            4: "„É≠„Çº„ÉÉ„Çø„Å¶„Çì„ÇÇ„Çì„Å†„ÅÑ",
            5: "DK„Çπ„Éé„Éº„Éû„Ç¶„É≥„ÉÜ„É≥",
            6: "„ÇΩ„É´„ÉÜ„Ç£„Éº„Çø„Ç¶„É≥",
            7: "„Éè„ÉÜ„Éä„Åó„Çì„Åß„Çì",
            8: "„Åä„Å∞„Åë„Ç∑„Éç„Éû",
            9: "„Ç∑„Éß„Éº„Éã„É•„Éº„É≠„Éº„Éâ",
            10: "„Éó„ÇØ„Éó„ÇØ„Éï„Ç©„Éº„É´„Ç∫",
            11: "„É™„Éê„Éº„Çµ„Ç§„Éâ„Çµ„Éï„Ç°„É™",
            12: "„Éá„Ç£„Éé„Éá„Ç£„Éé„Ç∏„É£„É≥„Ç∞„É´",
            13: "„Å©„Çì„Åê„Çä„ÉÑ„É™„Éº„Éè„Ç¶„Çπ",
            14: "„Éû„É™„Ç™„Çµ„Éº„Ç≠„ÉÉ„Éà",
            15: "„É¢„Éº„É¢„Éº„Ç´„É≥„Éà„É™„Éº",
            16: "„Éî„Éº„ÉÅ„Çπ„Çø„Ç∏„Ç¢„É†",
            17: "„Éé„Ç≥„Éé„Ç≥„Éì„Éº„ÉÅ",
            18: "„Éõ„Éç„Éõ„Éç„ÉÑ„Ç§„Çπ„Çø„Éº",
            19: "„Ç≠„Éé„Éî„Ç™„Éï„Ç°„ÇØ„Éà„É™„Éº",
            20: "„ÉÅ„Éß„Ç≥„Éû„Ç¶„É≥„ÉÜ„É≥",
            21: "„Éà„É≠„Éï„Ç£„Éº„Ç∑„ÉÜ„Ç£",
            22: "DK„ÅÜ„Å°„ÇÖ„ÅÜ„Çª„É≥„Çø„Éº",
            23: "„ÇØ„ÉÉ„Éë„Ç≠„É£„ÉÉ„Çπ„É´",
            24: "„ÉØ„É™„Ç™„Çπ„Çø„Ç∏„Ç¢„É†",
            25: "„Éû„É™„Ç™„Éñ„É©„Ç∂„Éº„Ç∫„Çµ„Éº„Ç≠„ÉÉ„Éà",
            26: "„Ç∑„É•„Éù„Éù„Ç≥„Éº„Çπ„Çø„Éº",
            27: "„Ç≠„É©„Éº„Ç∑„ÉÉ„Éó",
            28: "„Éò„Ç§„Éõ„Éº„Ç´„Éº„Éã„Éê„É´",
            29: "„Çµ„É≥„Çµ„É≥„Åï„Å∞„Åè",
            30: "„É¨„Ç§„É≥„Éú„Éº„É≠„Éº„Éâ"
        };

        // B„É¢„Éº„Éâ„ÅÆ„Ç≥„Éº„ÇπÊé•Á∂ö„Éá„Éº„Çø
        const courseConnections = {
            1: [2,4,5,6,9],
            2: [1,2,4,5,6,10],
            3: [2,6,7,11],
            4: [1,2,5,8,9,10,14],
            5: [1,2,4,6,9,10,15],
            6: [2,3,5,7,10,11,12],
            7: [3,6,11,12,17],
            8: [4,9,13,14,18],
            9: [1,4,5,8,10,13,14,15,19],
            10: [2,4,5,6,9,11,15,16],
            11: [6,7,10,12,16,17,21],
            12: [6,7,11,17],
            13: [8,9,14,18,19],
            14: [8,9,13,15,18,19,23],
            15: [9,10,14,16,18,19,20],
            16: [10,11,15,17,19,20,21],
            17: [11,12,16,21,22],
            18: [8,13,14,15,19,23,24,27],
            19: [9,13,14,15,16,18,20,23,24,25,27],
            20: [15,16,19,21,23,24,25,26,28],
            21: [11,15,16,17,20,22,24,25,26,29],
            22: [16,17,21,26],
            23: [14,18,19,20,27],
            24: [18,19,20,21,23,25,27,28],
            25: [19,20,21,24,26,28,29],
            26: [20,21,22,25,29],
            27: [18,19,23,24,28],
            28: [20,24,25,27,29],
            29: [21,25,26,28]
        };

        // „Éá„Éº„Çø‰øùÂ≠òÁî®
        let raceData = JSON.parse(localStorage.getItem('raceData')) || {
            A: {}, // A[courseId] = [rank1, rank2, ...]
            B: {}  // B["start-goal"] = [rank1, rank2, ...]
        };

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initializeSelects();
            updateCourseSelection();
        });

        function initializeSelects() {
            // A„É¢„Éº„ÉâÁî®„Ç≥„Éº„ÇπÈÅ∏Êäû
            const courseASelect = document.getElementById('courseA');
            for (let i = 1; i <= 30; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}. ${courseNames[i]}`;
                courseASelect.appendChild(option);
            }

            // B„É¢„Éº„ÉâÁî®„Çπ„Çø„Éº„Éà„Ç≥„Éº„ÇπÈÅ∏Êäû
            const startCourseSelect = document.getElementById('startCourse');
            for (let i = 1; i <= 29; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}. ${courseNames[i]}`;
                startCourseSelect.appendChild(option);
            }

            // È†Ü‰ΩçÈÅ∏ÊäûÔºàA„ÉªBÂÖ±ÈÄöÔºâ
            const rankSelects = ['rankA', 'rankB'];
            rankSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                for (let i = 1; i <= 24; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}‰Ωç`;
                    select.appendChild(option);
                }
            });
        }

        function switchMode(mode) {
            const buttons = document.querySelectorAll('.mode-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // „Åô„Åπ„Å¶„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈùûË°®Á§∫
            document.getElementById('input-section').classList.add('hidden');
            document.getElementById('stats-section').classList.add('hidden');
            document.getElementById('csv-section').classList.add('hidden');
            
            if (mode === 'input') {
                buttons[0].classList.add('active');
                document.getElementById('input-section').classList.remove('hidden');
            } else if (mode === 'stats') {
                buttons[1].classList.add('active');
                document.getElementById('stats-section').classList.remove('hidden');
                updateStatsCoursesSelect();
            } else if (mode === 'csv') {
                buttons[2].classList.add('active');
                document.getElementById('csv-section').classList.remove('hidden');
            }
        }

        function updateCourseSelection() {
            const gameMode = document.getElementById('gameMode').value;
            const modeAInputs = document.getElementById('mode-a-inputs');
            const modeBInputs = document.getElementById('mode-b-inputs');
            
            if (gameMode === 'A') {
                modeAInputs.classList.remove('hidden');
                modeBInputs.classList.add('hidden');
            } else {
                modeAInputs.classList.add('hidden');
                modeBInputs.classList.remove('hidden');
            }
        }

        function updateGoalCourses() {
            const startCourse = parseInt(document.getElementById('startCourse').value);
            const goalCourseSelect = document.getElementById('goalCourse');
            
            // „Ç¥„Éº„É´„Ç≥„Éº„ÇπÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
            goalCourseSelect.innerHTML = '<option value="">„Ç¥„Éº„É´„Ç≥„Éº„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
            
            if (startCourse && courseConnections[startCourse]) {
                courseConnections[startCourse].forEach(goalId => {
                    const option = document.createElement('option');
                    option.value = goalId;
                    option.textContent = `${goalId}. ${courseNames[goalId]}`;
                    goalCourseSelect.appendChild(option);
                });
            }
        }

        function addRecord(mode) {
            let courseKey, rank;
            
            if (mode === 'A') {
                const courseId = document.getElementById('courseA').value;
                rank = parseInt(document.getElementById('rankA').value);
                courseKey = courseId;
                
                if (!courseId || !rank) {
                    alert('„Ç≥„Éº„Çπ„Å®È†Ü‰Ωç„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
            } else {
                const startCourse = document.getElementById('startCourse').value;
                const goalCourse = document.getElementById('goalCourse').value;
                rank = parseInt(document.getElementById('rankB').value);
                courseKey = `${startCourse}-${goalCourse}`;
                
                if (!startCourse || !goalCourse || !rank) {
                    alert('„Çπ„Çø„Éº„Éà„Ç≥„Éº„Çπ„ÄÅ„Ç¥„Éº„É´„Ç≥„Éº„Çπ„ÄÅÈ†Ü‰Ωç„Çí„Åô„Åπ„Å¶ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
            }
            
            // „Éá„Éº„Çø‰øùÂ≠ò
            if (!raceData[mode][courseKey]) {
                raceData[mode][courseKey] = [];
            }
            raceData[mode][courseKey].push(rank);
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
            localStorage.setItem('raceData', JSON.stringify(raceData));
            
            // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
            showSuccessMessage();
            
            // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
            if (mode === 'A') {
                document.getElementById('courseA').value = '';
                document.getElementById('rankA').value = '';
            } else {
                document.getElementById('startCourse').value = '';
                document.getElementById('goalCourse').value = '';
                document.getElementById('rankB').value = '';
                updateGoalCourses();
            }
        }

        function showSuccessMessage() {
            const message = document.getElementById('success-message');
            message.classList.remove('hidden');
            setTimeout(() => {
                message.classList.add('hidden');
            }, 3000);
        }

        function updateStatsCoursesSelect() {
            const statsMode = document.getElementById('statsMode').value;
            const select = document.getElementById('statsCoursesSelect');
            
            select.innerHTML = '';
            
            if (statsMode === 'A') {
                for (let i = 1; i <= 30; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}. ${courseNames[i]}`;
                    select.appendChild(option);
                }
            } else {
                // B„É¢„Éº„Éâ„ÅÆ„Ç≥„Éº„ÇπÈñì„ÇíË°®Á§∫
                Object.keys(raceData.B).forEach(courseKey => {
                    const [start, goal] = courseKey.split('-');
                    const option = document.createElement('option');
                    option.value = courseKey;
                    option.textContent = `${courseNames[start]} ‚Üí ${courseNames[goal]}`;
                    select.appendChild(option);
                });
            }
        }

        function updateStatsDisplay() {
            updateStatsCoursesSelect();
        }

        function displayStats() {
            const statsMode = document.getElementById('statsMode').value;
            const selectedCourses = Array.from(document.getElementById('statsCoursesSelect').selectedOptions).map(option => option.value);
            const statsDisplay = document.getElementById('stats-display');
            
            if (selectedCourses.length === 0) {
                alert('Á¢∫Ë™ç„Åô„Çã„Ç≥„Éº„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            if (selectedCourses.length > 3) {
                alert('„Ç≥„Éº„Çπ„ÅØ3„Å§„Åæ„ÅßÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            statsDisplay.innerHTML = '';
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Ç≥„Éº„Çπ„ÅÆÁµ±Ë®à„ÇíË°®Á§∫
            selectedCourses.forEach(courseKey => {
                const data = raceData[statsMode][courseKey] || [];
                const avgRank = data.length > 0 ? (data.reduce((sum, rank) => sum + rank, 0) / data.length).toFixed(2) : '„Éá„Éº„Çø„Å™„Åó';
                
                let courseName;
                if (statsMode === 'A') {
                    courseName = courseNames[courseKey];
                } else {
                    const [start, goal] = courseKey.split('-');
                    courseName = `${courseNames[start]} ‚Üí ${courseNames[goal]}`;
                }
                
                const statCard = document.createElement('div');
                statCard.className = 'stat-card';
                statCard.innerHTML = `
                    <h3>${courseName}</h3>
                    <div class="value">${avgRank}</div>
                    <div>Âπ≥ÂùáÈ†Ü‰Ωç (${data.length}Âõû)</div>
                `;
                statsDisplay.appendChild(statCard);
            });
            
            // A„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÄÅ„Åä„Åæ„Åã„ÅõÁµ±Ë®à„ÇÇËøΩÂä†
            if (statsMode === 'A') {
                const excludedCourses = selectedCourses.map(c => parseInt(c));
                const otherCourses = [];
                
                for (let i = 1; i <= 30; i++) {
                    if (!excludedCourses.includes(i) && raceData.A[i] && raceData.A[i].length > 0) {
                        otherCourses.push(...raceData.A[i]);
                    }
                }
                
                const omakaseAvg = otherCourses.length > 0 ? (otherCourses.reduce((sum, rank) => sum + rank, 0) / otherCourses.length).toFixed(2) : '„Éá„Éº„Çø„Å™„Åó';
                
                const omakaseCard = document.createElement('div');
                omakaseCard.className = 'stat-card';
                omakaseCard.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #feca57 100%)';
                omakaseCard.innerHTML = `
                    <h3>„Åä„Åæ„Åã„Åõ</h3>
                    <div class="value">${omakaseAvg}</div>
                    <div>‰ªñ„Ç≥„Éº„ÇπÂπ≥ÂùáÈ†Ü‰Ωç (${otherCourses.length}Âõû)</div>
                `;
                statsDisplay.appendChild(omakaseCard);
            }
        }


      

        function clearAllData() {
            if (confirm('„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                raceData = { A: {}, B: {} };
                localStorage.removeItem('raceData');
                document.getElementById('stats-display').innerHTML = '';
                alert('„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
            }
        }

        // CSVÊ©üËÉΩ
        function exportToCSV(mode) {
            let csvContent = '';
            let filename = '';
            
            if (mode === 'A') {
                csvContent = 'Mode,Course,CourseName,Rank,Date\n';
                filename = 'race_data_A_mode.csv';
                
                Object.keys(raceData.A).forEach(courseId => {
                    const courseName = courseNames[courseId];
                    raceData.A[courseId].forEach(rank => {
                        const date = new Date().toISOString().split('T')[0];
                        csvContent += `A,${courseId},"${courseName}",${rank},${date}\n`;
                    });
                });
            } else if (mode === 'B') {
                csvContent = 'Mode,StartCourse,StartCourseName,GoalCourse,GoalCourseName,Rank,Date\n';
                filename = 'race_data_B_mode.csv';
                
                Object.keys(raceData.B).forEach(courseKey => {
                    const [startCourse, goalCourse] = courseKey.split('-');
                    const startCourseName = courseNames[startCourse];
                    const goalCourseName = courseNames[goalCourse];
                    raceData.B[courseKey].forEach(rank => {
                        const date = new Date().toISOString().split('T')[0];
                        csvContent += `B,${startCourse},"${startCourseName}",${goalCourse},"${goalCourseName}",${rank},${date}\n`;
                    });
                });
            } else if (mode === 'ALL') {
                csvContent = 'Mode,Course,CourseName,StartCourse,StartCourseName,GoalCourse,GoalCourseName,Rank,Date\n';
                filename = 'race_data_all.csv';
                
                // A„É¢„Éº„Éâ„Éá„Éº„Çø
                Object.keys(raceData.A).forEach(courseId => {
                    const courseName = courseNames[courseId];
                    raceData.A[courseId].forEach(rank => {
                        const date = new Date().toISOString().split('T')[0];
                        csvContent += `A,${courseId},"${courseName}",,,,${rank},${date}\n`;
                    });
                });
                
                // B„É¢„Éº„Éâ„Éá„Éº„Çø
                Object.keys(raceData.B).forEach(courseKey => {
                    const [startCourse, goalCourse] = courseKey.split('-');
                    const startCourseName = courseNames[startCourse];
                    const goalCourseName = courseNames[goalCourse];
                    raceData.B[courseKey].forEach(rank => {
                        const date = new Date().toISOString().split('T')[0];
                        csvContent += `B,,,"${startCourse}","${startCourseName}","${goalCourse}","${goalCourseName}",${rank},${date}\n`;
                    });
                });
            }
            
            if (csvContent === '' || csvContent.split('\n').length <= 1) {
                alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            downloadCSV(csvContent, filename);
            showCSVMessage(`${filename} „Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü„ÄÇ`);
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function downloadSampleCSV() {
            const sampleContent = 'Mode,Course,CourseName,StartCourse,StartCourseName,GoalCourse,GoalCourseName,Rank,Date\n' +
                                 'A,1,"„Ç¢„Ç§„Çπ„Éì„É´„Éá„Ç£„É≥„Ç∞",,,,3,2024-01-15\n' +
                                 'A,2,"„ÉØ„É™„Ç™„Ç∑„ÉÉ„Éó",,,,1,2024-01-15\n' +
                                 'B,,,1,"„Ç¢„Ç§„Çπ„Éì„É´„Éá„Ç£„É≥„Ç∞",2,"„ÉØ„É™„Ç™„Ç∑„ÉÉ„Éó",5,2024-01-15\n' +
                                 'B,,,2,"„ÉØ„É™„Ç™„Ç∑„ÉÉ„Éó",4,"„É≠„Çº„ÉÉ„Çø„Å¶„Çì„ÇÇ„Çì„Å†„ÅÑ",2,2024-01-15\n';
            
            downloadCSV(sampleContent, 'sample_race_data.csv');
            showCSVMessage('„Çµ„É≥„Éó„É´CSV„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü„ÄÇ');
        }

        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseCSV(e.target.result);
                    showCSVMessage('CSV„Éï„Ç°„Ç§„É´„ÅÆ„Ç§„É≥„Éù„Éº„Éà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ');
                    // „Éï„Ç°„Ç§„É´ÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢
                    document.getElementById('csvFileInput').value = '';
                } catch (error) {
                    alert('CSV„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function parseCSV(csvContent) {
            const lines = csvContent.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            if (lines.length <= 1) {
                throw new Error('CSV„Éï„Ç°„Ç§„É´„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
            }
            
            let importCount = 0;
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = parseCSVLine(line);
                if (values.length < headers.length) continue;
                
                const mode = values[0];
                const rank = parseInt(values[values.length - 2]); // ÊúÄÂæå„Åã„Çâ2Áï™ÁõÆ„ÅåÈ†Ü‰Ωç
                
                if (!mode || !rank || rank < 1 || rank > 24) continue;
                
                if (mode === 'A') {
                    const courseId = values[1];
                    if (courseId && courseNames[courseId]) {
                        if (!raceData.A[courseId]) {
                            raceData.A[courseId] = [];
                        }
                        raceData.A[courseId].push(rank);
                        importCount++;
                    }
                } else if (mode === 'B') {
                    // ÂÖ®„Éá„Éº„ÇøÂΩ¢Âºè„ÅÆÂ†¥Âêà
                    if (headers.includes('StartCourse') && headers.includes('GoalCourse')) {
                        const startIdx = headers.indexOf('StartCourse');
                        const goalIdx = headers.indexOf('GoalCourse');
                        const startCourse = values[startIdx].replace(/"/g, '');
                        const goalCourse = values[goalIdx].replace(/"/g, '');
                        
                        if (startCourse && goalCourse && courseNames[startCourse] && courseNames[goalCourse]) {
                            const courseKey = `${startCourse}-${goalCourse}`;
                            if (!raceData.B[courseKey]) {
                                raceData.B[courseKey] = [];
                            }
                            raceData.B[courseKey].push(rank);
                            importCount++;
                        }
                    } else {
                        // B„É¢„Éº„ÉâÂ∞ÇÁî®ÂΩ¢Âºè„ÅÆÂ†¥Âêà
                        const startCourse = values[1];
                        const goalCourse = values[3];
                        
                        if (startCourse && goalCourse && courseNames[startCourse] && courseNames[goalCourse]) {
                            const courseKey = `${startCourse}-${goalCourse}`;
                            if (!raceData.B[courseKey]) {
                                raceData.B[courseKey] = [];
                            }
                            raceData.B[courseKey].push(rank);
                            importCount++;
                        }
                    }
                }
            }
            
            if (importCount === 0) {
                throw new Error('ÊúâÂäπ„Å™„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
            }
            
            // „Éá„Éº„Çø„Çí‰øùÂ≠ò
            localStorage.setItem('raceData', JSON.stringify(raceData));
            
            console.log(`${importCount}‰ª∂„ÅÆ„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü„ÄÇ`);
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        function showCSVMessage(message) {
            const messageElement = document.getElementById('csv-message');
            messageElement.textContent = message;
            messageElement.classList.remove('hidden');
            setTimeout(() => {
                messageElement.classList.add('hidden');
            }, 3000);
        }
      function displayCombinedStats() {
    const statsDisplay = document.getElementById("stats-display");
    statsDisplay.innerHTML = "";

    // --- A„É¢„Éº„ÉâÁµ±Ë®à ---
    const selectedA = Array.from(document.getElementById("statsCoursesSelectA").selectedOptions).map(o => o.value);
    selectedA.slice(0, 3).forEach(courseId => {
        const data = raceData.A[courseId] || [];
        const avg = data.length > 0 ? (data.reduce((a, b) => a + b, 0) / data.length).toFixed(2) : "„Éá„Éº„Çø„Å™„Åó";

        const card = document.createElement("div");
        card.className = "stat-card";
        card.innerHTML = `
            <h3>${courseNames[courseId]}</h3>
            <div class="value">${avg}</div>
            <div>Âπ≥ÂùáÈ†Ü‰Ωç (${data.length}Âõû)</div>
        `;
        statsDisplay.appendChild(card);
    });

    // „Åä„Åæ„Åã„Åõ (A„É¢„Éº„Éâ)
    const excluded = selectedA.map(Number);
    const other = [];
    for (let i = 1; i <= 30; i++) {
        if (!excluded.includes(i) && raceData.A[i] && raceData.A[i].length > 0) {
            other.push(...raceData.A[i]);
        }
    }
    if (selectedA.length > 0) {
        const avg = other.length > 0 ? (other.reduce((a, b) => a + b, 0) / other.length).toFixed(2) : "„Éá„Éº„Çø„Å™„Åó";
        const card = document.createElement("div");
        card.className = "stat-card";
        card.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #feca57 100%)';
        card.innerHTML = `
            <h3>„Åä„Åæ„Åã„Åõ</h3>
            <div class="value">${avg}</div>
            <div>‰ªñ„Ç≥„Éº„ÇπÂπ≥ÂùáÈ†Ü‰Ωç (${other.length}Âõû)</div>
        `;
        statsDisplay.appendChild(card);
    }

    // --- B„É¢„Éº„ÉâÁµ±Ë®à ---
    const selectedB = Array.from(document.getElementById("statsCoursesSelectB").selectedOptions).map(o => o.value);
    selectedB.slice(0, 3).forEach(key => {
        const data = raceData.B[key] || [];
        const avg = data.length > 0 ? (data.reduce((a, b) => a + b, 0) / data.length).toFixed(2) : "„Éá„Éº„Çø„Å™„Åó";

        const [start, goal] = key.split("-");
        const label = `${courseNames[start]} ‚Üí ${courseNames[goal]}`;

        const card = document.createElement("div");
        card.className = "stat-card";
        card.innerHTML = `
            <h3>${label}</h3>
            <div class="value">${avg}</div>
            <div>Âπ≥ÂùáÈ†Ü‰Ωç (${data.length}Âõû)</div>
        `;
        statsDisplay.appendChild(card);
    });
}
    </script>
</body>
</html>
