<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã‚²ãƒ¼ãƒ  ãƒ‡ãƒ¼ã‚¿ãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .main-content {
            padding: 30px;
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 15px;
        }

        .mode-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .mode-btn.active {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            transform: translateY(-2px);
        }

        .mode-btn:not(.active) {
            background: #f8f9fa;
            color: #333;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #4ecdc4;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: end;
        }

        .form-col {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            background: white;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #a8e6cf, #dcedc8);
            color: #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .course-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .course-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
        }

        .course-name {
            font-weight: bold;
            color: #333;
        }

        .course-rank {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .hidden {
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #28a745;
        }

        .csv-format-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .format-example {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .mode-selector {
                flex-direction: column;
                align-items: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ ãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã‚²ãƒ¼ãƒ  ãƒ‡ãƒ¼ã‚¿ãƒˆãƒ©ãƒƒã‚«ãƒ¼</h1>
            <p>ã‚³ãƒ¼ã‚¹èµ°è¡Œãƒ‡ãƒ¼ã‚¿ã®è¨˜éŒ²ã¨åˆ†æ</p>
        </div>

        <div class="main-content">
            <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
            <div class="mode-selector">
                <button class="mode-btn active" onclick="switchMode('input')">ğŸ“ ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</button>
                <button class="mode-btn" onclick="switchMode('stats')">ğŸ“Š çµ±è¨ˆç¢ºèª</button>
                <button class="mode-btn" onclick="switchMode('csv')">ğŸ’¾ CSVç®¡ç†</button>
            </div>

            <!-- ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="input-section" class="section">
                <h2>ğŸ® ãƒ¬ãƒ¼ã‚¹çµæœå…¥åŠ›</h2>
                
      
                
                
                <!-- ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
                <div class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <label>ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰:</label>
                            <select id="gameMode" onchange="updateCourseSelection()">
                                <option value="A">Aãƒ¢ãƒ¼ãƒ‰ (å˜ä¸€ã‚³ãƒ¼ã‚¹)</option>
                                <option value="B">Bãƒ¢ãƒ¼ãƒ‰ (ã‚³ãƒ¼ã‚¹é–“èµ°è¡Œ)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Aãƒ¢ãƒ¼ãƒ‰ç”¨å…¥åŠ› -->
                <div id="mode-a-inputs" class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <label>ã‚³ãƒ¼ã‚¹:</label>
                            <select id="courseA">
                                <option value="">ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label>é †ä½:</label>
                            <select id="rankA">
                                <option value="">é †ä½ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <button class="btn" onclick="addRecord('A')">è¨˜éŒ²è¿½åŠ </button>
                        </div>
                    </div>
                </div>

                <!-- Bãƒ¢ãƒ¼ãƒ‰ç”¨å…¥åŠ› -->
                <div id="mode-b-inputs" class="form-group hidden">
                    <div class="form-row">
                        <div class="form-col">
                            <label>ã‚¹ã‚¿ãƒ¼ãƒˆã‚³ãƒ¼ã‚¹:</label>
                            <select id="startCourse" onchange="updateGoalCourses()">
                                <option value="">ã‚¹ã‚¿ãƒ¼ãƒˆã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label>ã‚´ãƒ¼ãƒ«ã‚³ãƒ¼ã‚¹:</label>
                            <select id="goalCourse">
                                <option value="">ã‚´ãƒ¼ãƒ«ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label>é †ä½:</label>
                            <select id="rankB">
                                <option value="">é †ä½ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <button class="btn" onclick="addRecord('B')">è¨˜éŒ²è¿½åŠ </button>
                        </div>
                    </div>
                </div>

                <div id="success-message" class="success-message hidden">
                    ãƒ¬ãƒ¼ã‚¹çµæœãŒæ­£å¸¸ã«è¨˜éŒ²ã•ã‚Œã¾ã—ãŸï¼
                </div>
            </div>

          <!-- çµ±è¨ˆç¢ºèªã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="stats-section" class="section hidden">
                <h2>ğŸ“Š çµ±è¨ˆãƒ‡ãƒ¼ã‚¿</h2>
                
                <!-- Aãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
                <div class="form-group">
                    <h3>ğŸ Aãƒ¢ãƒ¼ãƒ‰ (å˜ä¸€ã‚³ãƒ¼ã‚¹) - 3ã¤ã¾ã§é¸æŠ</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Aãƒ¢ãƒ¼ãƒ‰ã‚³ãƒ¼ã‚¹é¸æŠ:</label>
                            <select id="statsCoursesSelectA" multiple size="4">
                            </select>
                            <small>Ctrlã‚­ãƒ¼ã‚’æŠ¼ã—ãªãŒã‚‰ã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°é¸æŠ</small>
                        </div>
                    </div>
                </div>

                <!-- Bãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
                <div class="form-group">
                    <h3>ğŸï¸ Bãƒ¢ãƒ¼ãƒ‰ (ã‚³ãƒ¼ã‚¹é–“èµ°è¡Œ) - 3ã¤ã¾ã§é¸æŠ</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Bãƒ¢ãƒ¼ãƒ‰ã‚³ãƒ¼ã‚¹é–“é¸æŠ:</label>
                            <select id="statsCoursesSelectB" multiple size="4">
                            </select>
                            <small>Ctrlã‚­ãƒ¼ã‚’æŠ¼ã—ãªãŒã‚‰ã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°é¸æŠ</small>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
                <div class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <button class="btn" onclick="displayCombinedStats()">Aãƒ»Bä¸¡ãƒ¢ãƒ¼ãƒ‰çµ±è¨ˆè¡¨ç¤º</button>
                        </div>
                        <div class="form-col">
                            <button class="btn btn-secondary" onclick="clearAllData()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
                        </div>
                    </div>
                </div>

                <div id="stats-display" class="stats-grid">
                    <!-- çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
                <div id="stats-display" class="stats-grid">
                    <!-- çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>

            <!-- CSVç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="csv-section" class="section hidden">
                <h2>ğŸ’¾ CSV ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                
                <!-- CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
                <div class="form-group">
                    <h3>ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
                    <p>ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚</p>
                    <div class="form-row">
                        <div class="form-col">
                            <button class="btn" onclick="exportToCSV('A')">Aãƒ¢ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        </div>
                        <div class="form-col">
                            <button class="btn" onclick="exportToCSV('B')">Bãƒ¢ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        </div>
                        <div class="form-col">
                            <button class="btn" onclick="exportToCSV('ALL')">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        </div>
                    </div>
                </div>

                <!-- CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
                <div class="form-group">
                    <h3>ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
                    <p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚</p>
                    <div class="form-row">
                        <div class="form-col">
                            <label>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
                            <input type="file" id="csvFileInput" accept=".csv" onchange="handleCSVUpload(event)">
                        </div>
                        <div class="form-col">
                            <button class="btn btn-secondary" onclick="downloadSampleCSV()">ã‚µãƒ³ãƒ—ãƒ«CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        </div>
                    </div>
                </div>

                <!-- CSVå½¢å¼èª¬æ˜ -->
                <div class="form-group">
                    <h3>ğŸ“‹ CSVå½¢å¼ã«ã¤ã„ã¦</h3>
                    <div class="csv-format-info">
                        <p><strong>CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼:</strong></p>
                        <div class="format-example">
                            <p><strong>Aãƒ¢ãƒ¼ãƒ‰:</strong> Mode,Course,CourseName,Rank,Date</p>
                            <p><strong>Bãƒ¢ãƒ¼ãƒ‰:</strong> Mode,StartCourse,StartCourseName,GoalCourse,GoalCourseName,Rank,Date</p>
                        </div>
                        <p><small>â€» æ—¥ä»˜ã¯è‡ªå‹•ã§ç¾åœ¨æ™‚åˆ»ãŒè¨­å®šã•ã‚Œã¾ã™</small></p>
                    </div>
                </div>

                <div id="csv-message" class="success-message hidden">
                    CSVå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚³ãƒ¼ã‚¹åãƒ‡ãƒ¼ã‚¿
        const courseNames = {
            1: "ã‚¢ã‚¤ã‚¹ãƒ“ãƒ«ãƒ‡ã‚£ãƒ³ã‚°",
            2: "ãƒ¯ãƒªã‚ªã‚·ãƒƒãƒ—",
            3: "ãƒ”ãƒ¼ãƒãƒ“ãƒ¼ãƒ",
            4: "ãƒ­ã‚¼ãƒƒã‚¿ã¦ã‚“ã‚‚ã‚“ã ã„",
            5: "DKã‚¹ãƒãƒ¼ãƒã‚¦ãƒ³ãƒ†ãƒ³",
            6: "ã‚½ãƒ«ãƒ†ã‚£ãƒ¼ã‚¿ã‚¦ãƒ³",
            7: "ãƒãƒ†ãƒŠã—ã‚“ã§ã‚“",
            8: "ãŠã°ã‘ã‚·ãƒãƒ",
            9: "ã‚·ãƒ§ãƒ¼ãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ¼ãƒ‰",
            10: "ãƒ—ã‚¯ãƒ—ã‚¯ãƒ•ã‚©ãƒ¼ãƒ«ã‚º",
            11: "ãƒªãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚µãƒ•ã‚¡ãƒª",
            12: "ãƒ‡ã‚£ãƒãƒ‡ã‚£ãƒã‚¸ãƒ£ãƒ³ã‚°ãƒ«",
            13: "ã©ã‚“ãã‚Šãƒ„ãƒªãƒ¼ãƒã‚¦ã‚¹",
            14: "ãƒãƒªã‚ªã‚µãƒ¼ã‚­ãƒƒãƒˆ",
            15: "ãƒ¢ãƒ¼ãƒ¢ãƒ¼ã‚«ãƒ³ãƒˆãƒªãƒ¼",
            16: "ãƒ”ãƒ¼ãƒã‚¹ã‚¿ã‚¸ã‚¢ãƒ ",
            17: "ãƒã‚³ãƒã‚³ãƒ“ãƒ¼ãƒ",
            18: "ãƒ›ãƒãƒ›ãƒãƒ„ã‚¤ã‚¹ã‚¿ãƒ¼",
            19: "ã‚­ãƒãƒ”ã‚ªãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼",
            20: "ãƒãƒ§ã‚³ãƒã‚¦ãƒ³ãƒ†ãƒ³",
            21: "ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ã‚·ãƒ†ã‚£",
            22: "DKã†ã¡ã‚…ã†ã‚»ãƒ³ã‚¿ãƒ¼",
            23: "ã‚¯ãƒƒãƒ‘ã‚­ãƒ£ãƒƒã‚¹ãƒ«",
            24: "ãƒ¯ãƒªã‚ªã‚¹ã‚¿ã‚¸ã‚¢ãƒ ",
            25: "ãƒãƒªã‚ªãƒ–ãƒ©ã‚¶ãƒ¼ã‚ºã‚µãƒ¼ã‚­ãƒƒãƒˆ",
            26: "ã‚·ãƒ¥ãƒãƒã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼",
            27: "ã‚­ãƒ©ãƒ¼ã‚·ãƒƒãƒ—",
            28: "ãƒ˜ã‚¤ãƒ›ãƒ¼ã‚«ãƒ¼ãƒ‹ãƒãƒ«",
            29: "ã‚µãƒ³ã‚µãƒ³ã•ã°ã",
            30: "ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ãƒ­ãƒ¼ãƒ‰"
        };

        // Bãƒ¢ãƒ¼ãƒ‰ã®ã‚³ãƒ¼ã‚¹æ¥ç¶šãƒ‡ãƒ¼ã‚¿
        const courseConnections = {
            1: [2,4,5,6,9],
            2: [1,2,4,5,6,10],
            3: [2,6,7,11],
            4: [1,2,5,8,9,10,14],
            5: [1,2,4,6,9,10,15],
            6: [2,3,5,7,10,11,12],
            7: [3,6,11,12,17],
            8: [4,9,13,14,18],
            9: [1,4,5,8,10,13,14,15,19],
            10: [2,4,5,6,9,11,15,16],
            11: [6,7,10,12,16,17,21],
            12: [6,7,11,17],
            13: [8,9,14,18,19],
            14: [8,9,13,15,18,19,23],
            15: [9,10,14,16,18,19,20],
            16: [10,11,15,17,19,20,21],
            17: [11,12,16,21,22],
            18: [8,13,14,15,19,23,24,27],
            19: [9,13,14,15,16,18,20,23,24,25,27],
            20: [15,16,19,21,23,24,25,26,28],
            21: [11,15,16,17,20,22,24,25,26,29],
            22: [16,17,21,26],
            23: [14,18,19,20,27],
            24: [18,19,20,21,23,25,27,28],
            25: [19,20,21,24,26,28,29],
            26: [20,21,22,25,29],
            27: [18,19,23,24,28],
            28: [20,24,25,27,29],
            29: [21,25,26,28]
        };

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨
        let raceData = JSON.parse(localStorage.getItem('raceData')) || {
            A: {}, // A[courseId] = [rank1, rank2, ...]
            B: {}  // B["start-goal"] = [rank1, rank2, ...]
        };

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeSelects();
            updateCourseSelection();
        });

        function initializeSelects() {
            // Aãƒ¢ãƒ¼ãƒ‰ç”¨ã‚³ãƒ¼ã‚¹é¸æŠ
            const courseASelect = document.getElementById('courseA');
            for (let i = 1; i <= 30; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}. ${courseNames[i]}`;
                courseASelect.appendChild(option);
            }

            // Bãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ãƒ¼ãƒˆã‚³ãƒ¼ã‚¹é¸æŠ
            const startCourseSelect = document.getElementById('startCourse');
            for (let i = 1; i <= 29; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}. ${courseNames[i]}`;
                startCourseSelect.appendChild(option);
            }

            // é †ä½é¸æŠï¼ˆAãƒ»Bå…±é€šï¼‰
            const rankSelects = ['rankA', 'rankB'];
            rankSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                for (let i = 1; i <= 24; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}ä½`;
                    select.appendChild(option);
                }
            });
        }

        function switchMode(mode) {
            const buttons = document.querySelectorAll('.mode-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // ã™ã¹ã¦ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
            document.getElementById('input-section').classList.add('hidden');
            document.getElementById('stats-section').classList.add('hidden');
            document.getElementById('csv-section').classList.add('hidden');
            
            if (mode === 'input') {
                buttons[0].classList.add('active');
                document.getElementById('input-section').classList.remove('hidden');
            } else if (mode === 'stats') {
                buttons[1].classList.add('active');
                document.getElementById('stats-section').classList.remove('hidden');
                updateStatsCoursesSelect();
            } else if (mode === 'csv') {
                buttons[2].classList.add('active');
                document.getElementById('csv-section').classList.remove('hidden');
            }
        }

        function updateCourseSelection() {
            const gameMode = document.getElementById('gameMode').value;
            const modeAInputs = document.getElementById('mode-a-inputs');
            const modeBInputs = document.getElementById('mode-b-inputs');
            
            if (gameMode === 'A') {
                modeAInputs.classList.remove('hidden');
                modeBInputs.classList.add('hidden');
            } else {
                modeAInputs.classList.add('hidden');
                modeBInputs.classList.remove('hidden');
            }
        }

        function updateGoalCourses() {
            const startCourse = parseInt(document.getElementById('startCourse').value);
            const goalCourseSelect = document.getElementById('goalCourse');
            
            // ã‚´ãƒ¼ãƒ«ã‚³ãƒ¼ã‚¹é¸æŠã‚’ã‚¯ãƒªã‚¢
            goalCourseSelect.innerHTML = '<option value="">ã‚´ãƒ¼ãƒ«ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            
            if (startCourse && courseConnections[startCourse]) {
                courseConnections[startCourse].forEach(goalId => {
                    const option = document.createElement('option');
                    option.value = goalId;
                    option.textContent = `${goalId}. ${courseNames[goalId]}`;
                    goalCourseSelect.appendChild(option);
                });
            }
        }

        function addRecord(mode) {
            let courseKey, rank;
            
            if (mode === 'A') {
                const courseId = document.getElementById('courseA').value;
                rank = parseInt(document.getElementById('rankA').value);
                courseKey = courseId;
                
                if (!courseId || !rank) {
                    alert('ã‚³ãƒ¼ã‚¹ã¨é †ä½ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
            } else {
                const startCourse = document.getElementById('startCourse').value;
                const goalCourse = document.getElementById('goalCourse').value;
                rank = parseInt(document.getElementById('rankB').value);
                courseKey = `${startCourse}-${goalCourse}`;
                
                if (!startCourse || !goalCourse || !rank) {
                    alert('ã‚¹ã‚¿ãƒ¼ãƒˆã‚³ãƒ¼ã‚¹ã€ã‚´ãƒ¼ãƒ«ã‚³ãƒ¼ã‚¹ã€é †ä½ã‚’ã™ã¹ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
            }
            
            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            if (!raceData[mode][courseKey]) {
                raceData[mode][courseKey] = [];
            }
            raceData[mode][courseKey].push(rank);
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            localStorage.setItem('raceData', JSON.stringify(raceData));
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            showSuccessMessage();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            if (mode === 'A') {
                document.getElementById('courseA').value = '';
                document.getElementById('rankA').value = '';
            } else {
                document.getElementById('startCourse').value = '';
                document.getElementById('goalCourse').value = '';
                document.getElementById('rankB').value = '';
                updateGoalCourses();
            }
        }

        function showSuccessMessage() {
            const message = document.getElementById('success-message');
            message.classList.remove('hidden');
            setTimeout(() => {
                message.classList.add('hidden');
            }, 3000);
        }

        function updateStatsCoursesSelect() {
            const statsMode = document.getElementById('statsMode').value;
            const select = document.getElementById('statsCoursesSelect');
            
            select.innerHTML = '';
            
            if (statsMode === 'A') {
                for (let i = 1; i <= 30; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}. ${courseNames[i]}`;
                    select.appendChild(option);
                }
            } else {
                // Bãƒ¢ãƒ¼ãƒ‰ã®ã‚³ãƒ¼ã‚¹é–“ã‚’è¡¨ç¤º
                Object.keys(raceData.B).forEach(courseKey => {
                    const [start, goal] = courseKey.split('-');
                    const option = document.createElement('option');
                    option.value = courseKey;
                    option.textContent = `${courseNames[start]} â†’ ${courseNames[goal]}`;
                    select.appendChild(option);
                });
            }
        }

        function updateStatsDisplay() {
            updateStatsCoursesSelect();
        }

        function displayStats() {
            const statsMode = document.getElementById('statsMode').value;
            const selectedCourses = Array.from(document.getElementById('statsCoursesSelect').selectedOptions).map(option => option.value);
            const statsDisplay = document.getElementById('stats-display');
            
            if (selectedCourses.length === 0) {
                alert('ç¢ºèªã™ã‚‹ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (selectedCourses.length > 3) {
                alert('ã‚³ãƒ¼ã‚¹ã¯3ã¤ã¾ã§é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            statsDisplay.innerHTML = '';
            
            // é¸æŠã•ã‚ŒãŸã‚³ãƒ¼ã‚¹ã®çµ±è¨ˆã‚’è¡¨ç¤º
            selectedCourses.forEach(courseKey => {
                const data = raceData[statsMode][courseKey] || [];
                const avgRank = data.length > 0 ? (data.reduce((sum, rank) => sum + rank, 0) / data.length).toFixed(2) : 'ãƒ‡ãƒ¼ã‚¿ãªã—';
                
                let courseName;
                if (statsMode === 'A') {
                    courseName = courseNames[courseKey];
                } else {
                    const [start, goal] = courseKey.split('-');
                    courseName = `${courseNames[start]} â†’ ${courseNames[goal]}`;
                }
                
                const statCard = document.createElement('div');
                statCard.className = 'stat-card';
                statCard.innerHTML = `
                    <h3>${courseName}</h3>
                    <div class="value">${avgRank}</div>
                    <div>å¹³å‡é †ä½ (${data.length}å›)</div>
                `;
                statsDisplay.appendChild(statCard);
            });
            
            // Aãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ãŠã¾ã‹ã›çµ±è¨ˆã‚‚è¿½åŠ 
            if (statsMode === 'A') {
                const excludedCourses = selectedCourses.map(c => parseInt(c));
                const otherCourses = [];
                
                for (let i = 1; i <= 30; i++) {
                    if (!excludedCourses.includes(i) && raceData.A[i] && raceData.A[i].length > 0) {
                        otherCourses.push(...raceData.A[i]);
                    }
                }
                
                const omakaseAvg = otherCourses.length > 0 ? (otherCourses.reduce((sum, rank) => sum + rank, 0) / otherCourses.length).toFixed(2) : 'ãƒ‡ãƒ¼ã‚¿ãªã—';
                
                const omakaseCard = document.createElement('div');
                omakaseCard.className = 'stat-card';
                omakaseCard.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #feca57 100%)';
                omakaseCard.innerHTML = `
                    <h3>ãŠã¾ã‹ã›</h3>
                    <div class="value">${omakaseAvg}</div>
                    <div>ä»–ã‚³ãƒ¼ã‚¹å¹³å‡é †ä½ (${otherCourses.length}å›)</div>
                `;
                statsDisplay.appendChild(omakaseCard);
            }
        }


      

        function clearAllData() {
            if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                raceData = { A: {}, B: {} };
                localStorage.removeItem('raceData');
                document.getElementById('stats-display').innerHTML = '';
                alert('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚');
            }
        }

        // CSVæ©Ÿèƒ½
        function exportToCSV(mode) {
            let csvContent = '';
            let filename = '';
            
            if (mode === 'A') {
                csvContent = 'Mode,Course,CourseName,Rank,Date\n';
                filename = 'race_data_A_mode.csv';
                
                Object.keys(raceData.A).forEach(courseId => {
                    const courseName = courseNames[courseId];
                    raceData.A[courseId].forEach(rank => {
                        const date = new Date().toISOString().split('T')[0];
                        csvContent += `A,${courseId},"${courseName}",${rank},${date}\n`;
                    });
                });
            } else if (mode === 'B') {
                csvContent = 'Mode,StartCourse,StartCourseName,GoalCourse,GoalCourseName,Rank,Date\n';
                filename = 'race_data_B_mode.csv';
                
                Object.keys(raceData.B).forEach(courseKey => {
                    const [startCourse, goalCourse] = courseKey.split('-');
                    const startCourseName = courseNames[startCourse];
                    const goalCourseName = courseNames[goalCourse];
                    raceData.B[courseKey].forEach(rank => {
                        const date = new Date().toISOString().split('T')[0];
                        csvContent += `B,${startCourse},"${startCourseName}",${goalCourse},"${goalCourseName}",${rank},${date}\n`;
                    });
                });
            } else if (mode === 'ALL') {
                csvContent = 'Mode,Course,CourseName,StartCourse,StartCourseName,GoalCourse,GoalCourseName,Rank,Date\n';
                filename = 'race_data_all.csv';
                
                // Aãƒ¢ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿
                Object.keys(raceData.A).forEach(courseId => {
                    const courseName = courseNames[courseId];
                    raceData.A[courseId].forEach(rank => {
                        const date = new Date().toISOString().split('T')[0];
                        csvContent += `A,${courseId},"${courseName}",,,,${rank},${date}\n`;
                    });
                });
                
                // Bãƒ¢ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿
                Object.keys(raceData.B).forEach(courseKey => {
                    const [startCourse, goalCourse] = courseKey.split('-');
                    const startCourseName = courseNames[startCourse];
                    const goalCourseName = courseNames[goalCourse];
                    raceData.B[courseKey].forEach(rank => {
                        const date = new Date().toISOString().split('T')[0];
                        csvContent += `B,,,"${startCourse}","${startCourseName}","${goalCourse}","${goalCourseName}",${rank},${date}\n`;
                    });
                });
            }
            
            if (csvContent === '' || csvContent.split('\n').length <= 1) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            downloadCSV(csvContent, filename);
            showCSVMessage(`${filename} ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚`);
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function downloadSampleCSV() {
            const sampleContent = 'Mode,Course,CourseName,StartCourse,StartCourseName,GoalCourse,GoalCourseName,Rank,Date\n' +
                                 'A,1,"ã‚¢ã‚¤ã‚¹ãƒ“ãƒ«ãƒ‡ã‚£ãƒ³ã‚°",,,,3,2024-01-15\n' +
                                 'A,2,"ãƒ¯ãƒªã‚ªã‚·ãƒƒãƒ—",,,,1,2024-01-15\n' +
                                 'B,,,1,"ã‚¢ã‚¤ã‚¹ãƒ“ãƒ«ãƒ‡ã‚£ãƒ³ã‚°",2,"ãƒ¯ãƒªã‚ªã‚·ãƒƒãƒ—",5,2024-01-15\n' +
                                 'B,,,2,"ãƒ¯ãƒªã‚ªã‚·ãƒƒãƒ—",4,"ãƒ­ã‚¼ãƒƒã‚¿ã¦ã‚“ã‚‚ã‚“ã ã„",2,2024-01-15\n';
            
            downloadCSV(sampleContent, 'sample_race_data.csv');
            showCSVMessage('ã‚µãƒ³ãƒ—ãƒ«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
        }

        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseCSV(e.target.result);
                    showCSVMessage('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                    // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
                    document.getElementById('csvFileInput').value = '';
                } catch (error) {
                    alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function parseCSV(csvContent) {
            const lines = csvContent.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            if (lines.length <= 1) {
                throw new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            }
            
            let importCount = 0;
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = parseCSVLine(line);
                if (values.length < headers.length) continue;
                
                const mode = values[0];
                const rank = parseInt(values[values.length - 2]); // æœ€å¾Œã‹ã‚‰2ç•ªç›®ãŒé †ä½
                
                if (!mode || !rank || rank < 1 || rank > 24) continue;
                
                if (mode === 'A') {
                    const courseId = values[1];
                    if (courseId && courseNames[courseId]) {
                        if (!raceData.A[courseId]) {
                            raceData.A[courseId] = [];
                        }
                        raceData.A[courseId].push(rank);
                        importCount++;
                    }
                } else if (mode === 'B') {
                    // å…¨ãƒ‡ãƒ¼ã‚¿å½¢å¼ã®å ´åˆ
                    if (headers.includes('StartCourse') && headers.includes('GoalCourse')) {
                        const startIdx = headers.indexOf('StartCourse');
                        const goalIdx = headers.indexOf('GoalCourse');
                        const startCourse = values[startIdx].replace(/"/g, '');
                        const goalCourse = values[goalIdx].replace(/"/g, '');
                        
                        if (startCourse && goalCourse && courseNames[startCourse] && courseNames[goalCourse]) {
                            const courseKey = `${startCourse}-${goalCourse}`;
                            if (!raceData.B[courseKey]) {
                                raceData.B[courseKey] = [];
                            }
                            raceData.B[courseKey].push(rank);
                            importCount++;
                        }
                    } else {
                        // Bãƒ¢ãƒ¼ãƒ‰å°‚ç”¨å½¢å¼ã®å ´åˆ
                        const startCourse = values[1];
                        const goalCourse = values[3];
                        
                        if (startCourse && goalCourse && courseNames[startCourse] && courseNames[goalCourse]) {
                            const courseKey = `${startCourse}-${goalCourse}`;
                            if (!raceData.B[courseKey]) {
                                raceData.B[courseKey] = [];
                            }
                            raceData.B[courseKey].push(rank);
                            importCount++;
                        }
                    }
                }
            }
            
            if (importCount === 0) {
                throw new Error('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            localStorage.setItem('raceData', JSON.stringify(raceData));
            
            console.log(`${importCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚`);
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        function showCSVMessage(message) {
            const messageElement = document.getElementById('csv-message');
            messageElement.textContent = message;
            messageElement.classList.remove('hidden');
            setTimeout(() => {
                messageElement.classList.add('hidden');
            }, 3000);
        }
      function displayCombinedStats() {
    const statsDisplay = document.getElementById("stats-display");
    statsDisplay.innerHTML = "";

    // --- Aãƒ¢ãƒ¼ãƒ‰çµ±è¨ˆ ---
    const selectedA = Array.from(document.getElementById("statsCoursesSelectA").selectedOptions).map(o => o.value);
    selectedA.slice(0, 3).forEach(courseId => {
        const data = raceData.A[courseId] || [];
        const avg = data.length > 0 ? (data.reduce((a, b) => a + b, 0) / data.length).toFixed(2) : "ãƒ‡ãƒ¼ã‚¿ãªã—";

        const card = document.createElement("div");
        card.className = "stat-card";
        card.innerHTML = `
            <h3>${courseNames[courseId]}</h3>
            <div class="value">${avg}</div>
            <div>å¹³å‡é †ä½ (${data.length}å›)</div>
        `;
        statsDisplay.appendChild(card);
    });

    // ãŠã¾ã‹ã› (Aãƒ¢ãƒ¼ãƒ‰)
    const excluded = selectedA.map(Number);
    const other = [];
    for (let i = 1; i <= 30; i++) {
        if (!excluded.includes(i) && raceData.A[i] && raceData.A[i].length > 0) {
            other.push(...raceData.A[i]);
        }
    }
    if (selectedA.length > 0) {
        const avg = other.length > 0 ? (other.reduce((a, b) => a + b, 0) / other.length).toFixed(2) : "ãƒ‡ãƒ¼ã‚¿ãªã—";
        const card = document.createElement("div");
        card.className = "stat-card";
        card.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #feca57 100%)';
        card.innerHTML = `
            <h3>ãŠã¾ã‹ã›</h3>
            <div class="value">${avg}</div>
            <div>ä»–ã‚³ãƒ¼ã‚¹å¹³å‡é †ä½ (${other.length}å›)</div>
        `;
        statsDisplay.appendChild(card);
    }

    // --- Bãƒ¢ãƒ¼ãƒ‰çµ±è¨ˆ ---
    const selectedB = Array.from(document.getElementById("statsCoursesSelectB").selectedOptions).map(o => o.value);
    selectedB.slice(0, 3).forEach(key => {
        const data = raceData.B[key] || [];
        const avg = data.length > 0 ? (data.reduce((a, b) => a + b, 0) / data.length).toFixed(2) : "ãƒ‡ãƒ¼ã‚¿ãªã—";

        const [start, goal] = key.split("-");
        const label = `${courseNames[start]} â†’ ${courseNames[goal]}`;

        const card = document.createElement("div");
        card.className = "stat-card";
        card.innerHTML = `
            <h3>${label}</h3>
            <div class="value">${avg}</div>
            <div>å¹³å‡é †ä½ (${data.length}å›)</div>
        `;
        statsDisplay.appendChild(card);
    });
}
    </script>
</body>
</html>
